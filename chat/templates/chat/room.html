<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
    <style>
        .profile-image{
    display: flex;
    height: 30px;
    width: 30px;
    border-radius: 50%;
    overflow: hidden;
}
.attach-icon{
    cursor: pointer;
}
.img-form-hide{
    transform: translateY(0%) !important;
    display: block !important;  
}
.image-form{
    padding: 100px;
    display: flex;
    flex-direction: column;
}
.image-form div{
    margin: 40px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
.image-message-img{
    max-height:200px;
    max-width:200px;
    height:auto;
    width:auto;
}

    </style>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'room/style.css' %}">
    <link href="{% static 'nav/style.css' %}" rel="stylesheet" type="text/css">
    
    <title>Chat</title>
</head>
<body>
    <nav>
        <div class="logo">
            <h4>Connect-e-Fans</h4>
        </div>
        <ul class="nav-links">
            <li><a href="/home">Home</a></li>
            <li><a href="/rooms">All Rooms</a></li>
            <li><div class="profile-image"><img src="{{user.image.url}}" alt=""></div></li>
            <li><a href="/profile">{{user.username}}</a></li>
            <li><a href="/logout">Logout</a></li>
        </ul>
        <div class="burger">
            <div class="line11"></div>
            <div class="line21"></div>
            <div class="line31"></div>
        </div>
    </nav>
    <main>
        <section class="glass">
            <div class="header">
                <div class="room-image">
                    <img src="{{instance.image.url}}">
                </div>
                <div class="room-name"><a href="/room/{{instance.name}}">{{instance.name}}</a></div>
            </div>
            <div class="messages" id="chat-log">
                {% for message in messages %}
                    {% if message.author.username == user.username %}
                    <div class="message">
                        <div class="outgoing-message">
                            <div class="message-header">
                                <a>{{message.author.username}}&nbsp;&nbsp;</a>
                                <p>{{message.timestamp}}</p>
                            </div>
                            <div class="message-body">
                                {% if message.image %}
                                <img src="{{message.image.url}}" class="image-message-img">
                                {%endif%}
                                <br>
                                {{message.content}}
                            </div>
                        </div>
                    </div>
                    {%else%}
                    <div class="message">
                        <div class="incoming-message">
                            <div class="message-header">
                                <a href="/user/{{message.author.username}}">{{message.author.username}} &nbsp;&nbsp;</a>
                                <p>{{message.timestamp}}</p>
                            </div>
                            <div class="message-body">
                                {% if message.image %}
                                <img src="{{message.image.url}}" class="image-message-img">
                                {%endif%}
                                <br>
                            {{message.content}}
                            </div>
                        </div>
                    </div>
                    {%endif%}
                {% endfor %}
            </div>
            <div class="footer">
                <input type="text" class="message-box" placeholder="Type Your Message" id="chat-message-input">
                <div class="attach-icon">
                <svg id="Layer_1" enable-background="new 0 0 508.258 508.258" height="5vh" viewBox="0 0 508.258 508.258" width="5vh" xmlns="http://www.w3.org/2000/svg"><g><path d="m267.167 35.44-243.442 222.791 20.254 22.131 243.442-222.792c42.47-38.869 107.775-36.123 146.945 5.077l18.489-4.347 2.733-16.875c-50.621-52.676-134.204-55.602-188.421-5.985z" fill="#76e2f8"/><path d="m66.949 361.007 260.04-237.981c12.533-11.47 32.526-10.448 43.644 3.355l19.611-5.469 1.661-15.803c-22.353-24.927-60.573-26.725-85.17-4.213l-260.04 237.98c-36.645 33.534-41.303 87.681-15.02 126.462l15.97-1.828 5.83-19.972c-14.617-26.253-10.396-60.688 13.474-82.531z" fill="#76e2f8"/><g fill="#4bb9ec"><path d="m455.589 41.425-21.223 21.223c40.777 42.938 38.006 110.328-5.17 149.841l-271.106 248.108c-32.218 29.486-83.392 21.045-104.614-17.06l-21.8 21.8c33.592 49.577 103.036 57.32 146.668 17.391l271.106-248.108c55.688-50.963 58.859-138.326 6.139-193.195z"/><path d="m367.497 167.288-232.377 212.664 20.254 22.131 232.377-212.663c24.278-22.218 26.156-59.786 4.154-84.311l-21.272 21.272c9.782 12.152 8.692 30.083-3.136 40.907z"/></g></g></svg>
                </div>

                <div class="send" id="chat-message-submit"><svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                    viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve">
               <path style="fill:#84DBFF;" d="M512,256.001c0,20.361-11.68,37.862-30.491,45.662L68.412,473.08
                   c-17.036,7.068-36.766,4.295-51.312-8.29C2.859,452.46-3.101,433.449,1.559,415.198L38.33,271.002l3.82-15.001L38.33,241
                   L1.559,96.805c-4.66-18.251,1.3-37.262,15.541-49.592c14.084-12.185,33.727-15.586,51.312-8.29L481.509,210.34
                   C500.32,218.14,512,235.641,512,256.001z"/>
               <path style="fill:#54C9EB;" d="M38.331,271.002L1.559,415.198c-4.66,18.251,1.3,37.261,15.541,49.592
                   c14.546,12.586,34.276,15.359,51.312,8.29l413.097-171.417c18.811-7.8,30.491-25.301,30.491-45.662H42.151L38.331,271.002z"/>
               <path style="fill:#EFEFEF;" d="M233.349,256.001c0,8.28-6.71,15.001-15.001,15.001H38.331l3.82-15.001L38.331,241h180.017
                   C226.638,241.001,233.349,247.721,233.349,256.001z"/>
               <path style="fill:#C5D8DF;" d="M38.331,271.002h180.017c8.29,0,15.001-6.72,15.001-15.001H42.151L38.331,271.002z"/></svg></div>
            </div>
        </section>
        <div class="image-form-section ">
            <div class="header">
                <div class="cross-button">
                    <svg height="3vh" viewBox="0 0 329.26933 329" width="3vh" xmlns="http://www.w3.org/2000/svg"><path d="m194.800781 164.769531 128.210938-128.214843c8.34375-8.339844 8.34375-21.824219 0-30.164063-8.339844-8.339844-21.824219-8.339844-30.164063 0l-128.214844 128.214844-128.210937-128.214844c-8.34375-8.339844-21.824219-8.339844-30.164063 0-8.34375 8.339844-8.34375 21.824219 0 30.164063l128.210938 128.214843-128.210938 128.214844c-8.34375 8.339844-8.34375 21.824219 0 30.164063 4.15625 4.160156 9.621094 6.25 15.082032 6.25 5.460937 0 10.921875-2.089844 15.082031-6.25l128.210937-128.214844 128.214844 128.214844c4.160156 4.160156 9.621094 6.25 15.082032 6.25 5.460937 0 10.921874-2.089844 15.082031-6.25 8.34375-8.339844 8.34375-21.824219 0-30.164063zm0 0"/></svg>
                </div>

            </div>
            <div class="image-form">
                <form method="post" enctype="multipart/form-data" id="id_ajax_upload_form" novalidate>
                    {% csrf_token %}
                                        <div><input type="file" name="image"></div>
                    <div><input type="submit" class="btn-lg image-submit" value="Send" style="align-items: center;"></div>
                    
                </form>
            </div>
        </div>
    </main>
    <div class="circle1"></div>
    <div class="circle2"></div>
</body>
<script src="{%static 'reconnecting-websocket.js' %}"></script>
<script>
    var roomName = {{room_name_json}}
    var username = {{username}}

    var chatSocket = new ReconnectingWebSocket(
        'ws://'
        + window.location.host
        + '/ws/chat/'
        + roomName
        + '/'
    );

    const scrollBottom = () =>{
        var elem = document.getElementById('chat-log');
        elem.scrollTop = elem.scrollHeight;
    }

    chatSocket.onmessage = function(e) {
            var data = JSON.parse(e.data);
            var type=data['type']
            var message = data['message']
            var author = message['author']
            var all_message_box=document.querySelector('.messages')
            var outer_message_box=document.createElement('div');
            var message_box=document.createElement('div');
            var message_header=document.createElement('div');
            var message_body=document.createElement('div');
            var name=document.createElement('a');
            var time=document.createElement('p');
            name.innerText=author
            time.innerText=message['timestamp']
            outer_message_box.className = 'message'
            message_header.className='message-header'
            message_body.className='message-body'
            message_body.innerText=message['content']
            if(type=='image_message'){
                var img=document.createElement('img');
                img.src=message.image 
                img.className='image-message-img'
                message_body.appendChild(img)
            }
            if (author==username){
                message_box.className='outgoing-message'
            }
            else{
                name.href="/user/"+author
                message_box.className='incoming-message'
            }
            message_header.appendChild(name)
            message_header.appendChild(time)
            message_box.appendChild(message_header)
            message_box.appendChild(message_body)
            outer_message_box.appendChild(message_box)
            all_message_box.appendChild(outer_message_box)
            document.querySelector('#chat-log').appendChild(outer_message_box)
            scrollBottom()
        };

    
    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').addEventListener('click',function(e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'room':roomName,
            'message': message,
            'command': 'new_message',
            'from':username
        }));
        messageInputDom.value = '';
        console.log('sent')
    });
</script>
<script src="{% static 'nav/app.js' %}"></script>
<script>
    
    const attachButton=document.querySelector('.attach-icon')
    attachButton.addEventListener('click',function(e){
        document.querySelector('.image-form-section').classList.add('img-form-hide')
    });
    document.querySelector('.cross-button').addEventListener('click',function(e){
        document.querySelector('.image-form-section').classList.remove('img-form-hide')
    });
    document.querySelector('.image-submit').addEventListener('click',function(e){
        document.querySelector('.image-form-section').classList.remove('img-form-hide')
    });
</script>
<script 
   src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
   <script type="text/javascript">
    // form upload
    $('#id_ajax_upload_form').submit(function(e){
        e.preventDefault();
        $form = $(this)
        var formData = new FormData(this);
        $.ajax({
            url: window.location.pathname,
            type: 'POST',
            data: formData,
            success: function (response) {
                console.log(response)
            },
            cache: false,
            contentType: false,
            processData: false
        });
    });
    // end
   </script>

</html>